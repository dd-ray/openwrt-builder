name: OpenWrt-CI

on:
  workflow_dispatch:
    inputs:
      REPO_URL:
        description: "OpenWrt仓库"
        required: true
        default: "openwrt/openwrt"
        type: choice
        options:
          - "openwrt/openwrt"
      REPO_BRANCH:
        description: "OpenWrt分支"
        required: true
        default: "main"
        type: choice
        options:
          - "main"
          - "openwrt-24.10"
      CCACHE:
        description: "Enable ccache (Use Cache to speed up next build)"
        type: boolean
        default: true

env:
  REPO_URL: "https://github.com/${{ github.event.inputs.REPO_URL }}.git"
  REPO_BRANCH: ${{ github.event.inputs.REPO_BRANCH }}
  SOURCE_PATH: "/openwrt/openwrt-source"
  TZ: Asia/Shanghai
  BUILDER_PATH: ${{ github.workspace }}
jobs:
  build:
    runs-on: ubuntu-latest
    name: Build ${{matrix.DEVICE}}
    strategy:
      fail-fast: false
      matrix:
        DEVICE: ["nanopi-r5s", "cudy-tr3000", "x86_64"]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Space cleanup
        uses: dd-ray/github-actions@free-disk
        with:
          build-mount-path: /openwrt
      - name: Build System Setup
        uses: dd-ray/github-actions@openwrt-build-setup
      - name: Install LLVM
        uses: dd-ray/github-actions@install-llvm
      - name: Clone OpenWrt
        run: |
          ./script/tool.sh clone
          ln -sf ${{ env.SOURCE_PATH }} ${{ github.workspace }}/openwrt-source
      - name: Set Environment Variables
        run: |
          if [ ${{ matrix.DEVICE }} == "nanopi-r5s" ]; then
            DEVICE_PLATFORM="arm64"
          elif [ ${{ matrix.DEVICE }} == "cudy-tr3000" ]; then
            DEVICE_PLATFORM="arm64"
          elif [ ${{ matrix.DEVICE }} == "x86_64" ]; then
            DEVICE_PLATFORM="amd64"
          fi
          echo "DEVICE_PLATFORM=${DEVICE_PLATFORM}" >> $GITHUB_ENV

      - name: Restore ccache Cached
        if: ${{ github.event.inputs.CCACHE == 'true' }}
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.SOURCE_PATH }}/.ccache
          key: ${{ env.REPO_BRANCH }}-${{ env.DEVICE_PLATFORM }}-ccache
      - name: Restore staging_dir Cached
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.SOURCE_PATH }}/staging_dir
          key: ${{ env.REPO_BRANCH }}-${{ matrix.DEVICE }}-staging_dir

      - name: Update feeds
        run: ./script/tool.sh update_feeds
      - name: Generate configuration file
        env:
          CONFIG_FILE: ${{ matrix.DEVICE }}.seed
        run: ./script/tool.sh build_config
      - name: Make download
        run: ./script/tool.sh make_download
      - name: Compile firmware
        run: ./script/tool.sh compile_firmware
      - name: Clean Packages
        run: rm -rf ${{env.SOURCE_PATH}}/bin/targets/*/*/packages
      - name: Create release
        uses: ncipollo/release-action@v1.14.0
        with:
          name: OpenWrt-${{ env.REPO_BRANCH }}
          allowUpdates: true
          tag: ${{ env.REPO_BRANCH }}
          commit: main
          replacesArtifacts: true
          artifacts: |
            ${{env.SOURCE_PATH}}/bin/targets/*/*/openwrt-*
      - name: Upload OpenWrt firmware
        uses: actions/upload-artifact@master
        with:
          name: OpenWrt firmware ${{ matrix.DEVICE }}
          path: |
            ${{env.SOURCE_PATH}}/bin/targets/
      - name: Save ccache Cache
        uses: actions/cache/save@v4
        with:
          path: |
            ${{ env.SOURCE_PATH }}/.ccache
          key: ${{ env.REPO_BRANCH }}-${{ env.DEVICE_PLATFORM }}-ccache
      - name: Save staging_dir Cache
        uses: actions/cache/save@v4
        with:
          path: |
            ${{ env.SOURCE_PATH }}/staging_dir
          key: ${{ env.REPO_BRANCH }}-${{ matrix.DEVICE }}-staging_dir
