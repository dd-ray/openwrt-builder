name: OpenWrt-CI

on:
  workflow_dispatch:
    inputs:
      REPO_URL:
        description: 'OpenWrtä»“åº“'
        required: true
        default: 'openwrt/openwrt'
        type: choice
        options:
          - 'openwrt/openwrt'
      REPO_BRANCH:
        description: 'OpenWrtåˆ†æ”¯'
        required: true
        default: 'main'
        type: choice
        options:
          - 'main'
          - 'v25.12.0-rc1'
      CCACHE:
        description: 'Enable ccache (Use Cache to speed up next build)'
        type: boolean
        default: true

env:
  REPO_URL: "https://github.com/${{ github.event.inputs.REPO_URL }}.git"
  REPO_BRANCH: ${{ github.event.inputs.REPO_BRANCH }}
  SOURCE_PATH: "${{ github.workspace }}/openwrt-source"
  TZ: Asia/Shanghai
  BUILDER_PATH: ${{ github.workspace }}
jobs:
  build:
    runs-on: ubuntu-latest
    name: Build ${{matrix.DEVICE}}
    strategy:
      fail-fast: false
      matrix:
        DEVICE: ["nanopi-r5s", "cudy-tr3000", "x86_64"]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Space cleanup
        uses: dd-ray/github-actions@free-disk
        with:
          build-mount-path: "${{ env.SOURCE_PATH }}"
      - name: Build System Setup
        uses: dd-ray/github-actions@openwrt-build-setup
      - name: Install LLVM
        uses: dd-ray/github-actions@install-llvm
      - name: Clone OpenWrt
        run: |
          ./script/tool.sh clone
      - name: Cache
        uses: stupidloud/cachewrtbuild@main
        with:
          prefix: ${{ env.SOURCE_PATH }}
          #æ˜¯å¦ä¸€å¹¶ç¼“å­˜.ccacheç›®å½•ï¼Œå¦‚æœä½ å¯ç”¨äº†ccacheã€‚è¿™æ˜¯å”¯ä¸€çš„å¸¸ç”¨å‚æ•°ï¼Œå…¶ä»–ä¸‰ä¸ªç”¨äºé™¤é”™ï¼Œä¸€èˆ¬ä¸éœ€è¦è°ƒæ•´
          ccache: ${{ github.event.inputs.CCACHE }}
          #æ˜¯å¦ç¼“å­˜å·¥å…·é“¾ç›®å½•
          toolchain: true
          #æ˜¯å¦è·³è¿‡å·¥å…·é“¾ç¼–è¯‘
          skip: true
          #æ¸…ç©ºç¼“å­˜
          clean: false
          mixkey: ${{ matrix.DEVICE }}

      - name: Update feeds
        run: ./script/tool.sh update_feeds
      - name: Generate configuration file
        env:
          CONFIG_FILE: ${{ matrix.DEVICE }}.seed
        run: ./script/tool.sh build_config
      - name: Make download
        run: ./script/tool.sh make_download
      - name: Compile firmware
        run: ./script/tool.sh compile_firmware
      - name: Prepare firmware
        run: |
          rm -rf ${{env.SOURCE_PATH}}/bin/targets/*/*/packages
          mkdir -p ${{env.SOURCE_PATH}}/bin/output/
          cp -f ${{env.SOURCE_PATH}}/bin/targets/*/*/* ${{env.SOURCE_PATH}}/bin/output/
      - name: Set release Variable
        run: |
          echo "BUILD_TIME=$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
          if [ "${{ env.REPO_BRANCH }}" == "main" ]; then
            echo "RELEASE_BRANCH=Snapshot" >> $GITHUB_ENV
          else
            echo "RELEASE_BRANCH=${{ env.REPO_BRANCH }}" | sed 's/openwrt-//' >> $GITHUB_ENV
          fi
      - name: Create release
        uses: ncipollo/release-action@v1.18.0
        with:
          name: OpenWrt-${{ env.RELEASE_BRANCH }}-${{ matrix.DEVICE }}
          allowUpdates: true
          tag: ${{ env.REPO_BRANCH }}-${{ matrix.DEVICE }}
          commit: main
          replacesArtifacts: true
          artifacts: ${{env.SOURCE_PATH}}/bin/output/*
          body: |
            ## ğŸ¯ è®¾å¤‡ä¿¡æ¯
            - **è®¾å¤‡å‹å·**: ${{ matrix.DEVICE }}
            - **OpenWrt åˆ†æ”¯**: ${{ env.REPO_BRANCH }}
            - **æ„å»ºæ—¶é—´**: ${{ env.BUILD_TIME }}
            - **æ„å»ºç¼–å·**: #${{ github.run_number }}        

      - name: Upload OpenWrt firmware
        uses: actions/upload-artifact@master
        with:
          name: OpenWrt firmware ${{ matrix.DEVICE }}
          path: |
            ${{env.SOURCE_PATH}}/bin/targets/
