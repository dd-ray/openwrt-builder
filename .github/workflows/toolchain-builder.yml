name: Toolchain Builder

on:
  workflow_dispatch:
    inputs:
      REPO_URL:
        description: "OpenWrtä»“åº“"
        required: true
        default: "openwrt/openwrt"
        type: choice
        options:
          - "openwrt/openwrt"
      REPO_BRANCH:
        description: "OpenWrtåˆ†æ”¯"
        required: true
        default: "main"
        type: choice
        options:
          - "main"
          - "openwrt-24.10"
      FORCE_REBUILD:
        description: "å¼ºåˆ¶é‡æ–°æ„å»ºtoolchain"
        type: boolean
        default: false

env:
  REPO_URL: "https://github.com/${{ github.event.inputs.REPO_URL }}.git"
  REPO_BRANCH: ${{ github.event.inputs.REPO_BRANCH }}
  SOURCE_PATH: "/openwrt/openwrt-source"
  TZ: Asia/Shanghai
  BUILDER_PATH: ${{ github.workspace }}
  USE_CCACHE: "1"
  CCACHE_DIR: "/openwrt/ccache"

jobs:
  build-toolchain:
    runs-on: ubuntu-latest
    name: Build Toolchain ${{matrix.TOOLCHAIN_TYPE}}
    strategy:
      fail-fast: false
      matrix:
        include:
          - TOOLCHAIN_TYPE: "aarch64_generic"
            DEVICE_PLATFORM: "arm64"
            DEVICE: "nanopi-r5s"
          - TOOLCHAIN_TYPE: "aarch64_cortex-a53"
            DEVICE_PLATFORM: "arm64"
            DEVICE: "cudy-tr3000"
          - TOOLCHAIN_TYPE: "x86_64"
            DEVICE_PLATFORM: "amd64"
            DEVICE: "x86_64"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate device mapping
        run: |
          # éªŒè¯matrixä¸­çš„è®¾å¤‡æ˜ å°„ä¸è„šæœ¬ä¸­çš„æ˜ å°„æ˜¯å¦ä¸€è‡´
          source script/device-toolchain-mapping.sh

          EXPECTED_TOOLCHAIN=$(get_toolchain_type "${{ matrix.DEVICE }}")
          EXPECTED_PLATFORM=$(get_device_platform "${{ matrix.DEVICE }}")

          if [ "$EXPECTED_TOOLCHAIN" != "${{ matrix.TOOLCHAIN_TYPE }}" ]; then
            echo "âŒ Toolchain type mismatch for ${{ matrix.DEVICE }}"
            echo "   Expected: $EXPECTED_TOOLCHAIN"
            echo "   Matrix:   ${{ matrix.TOOLCHAIN_TYPE }}"
            exit 1
          fi

          if [ "$EXPECTED_PLATFORM" != "${{ matrix.DEVICE_PLATFORM }}" ]; then
            echo "âŒ Platform mismatch for ${{ matrix.DEVICE }}"
            echo "   Expected: $EXPECTED_PLATFORM"
            echo "   Matrix:   ${{ matrix.DEVICE_PLATFORM }}"
            exit 1
          fi

          echo "âœ… Device mapping validated: ${{ matrix.DEVICE }} -> ${{ matrix.TOOLCHAIN_TYPE }} (${{ matrix.DEVICE_PLATFORM }})"

      - name: Generate cache keys
        run: |
          # ç”Ÿæˆæ›´ç²¾ç¡®çš„ç¼“å­˜é”®
          CONFIG_HASH=$(find config/ -name "*.seed" -type f -exec cat {} \; | md5sum | cut -d' ' -f1)
          SOURCE_HASH=$(echo "${{ env.REPO_URL }}-${{ env.REPO_BRANCH }}" | md5sum | cut -d' ' -f1)

          # Toolchain ç¼“å­˜é”® - åŸºäºæºç ä»“åº“å’Œåˆ†æ”¯
          TOOLCHAIN_CACHE_KEY="toolchain-${{ env.REPO_BRANCH }}-${{ matrix.TOOLCHAIN_TYPE }}-${SOURCE_HASH}"

          # Build ç¼“å­˜é”® - åŸºäº toolchain + config
          BUILD_CACHE_KEY="build-${{ env.REPO_BRANCH }}-${{ matrix.TOOLCHAIN_TYPE }}-${CONFIG_HASH}"


          echo "TOOLCHAIN_CACHE_KEY=${TOOLCHAIN_CACHE_KEY}" >> $GITHUB_ENV
          echo "BUILD_CACHE_KEY=${BUILD_CACHE_KEY}" >> $GITHUB_ENV

          echo "ğŸ“‹ Cache keys generated:"
          echo "  Toolchain: ${TOOLCHAIN_CACHE_KEY}"
          echo "  Build: ${BUILD_CACHE_KEY}"

      - name: Check if toolchain exists
        if: ${{ github.event.inputs.FORCE_REBUILD != 'true' }}
        id: check_toolchain
        run: |
          RELEASE_TAG="toolchain"
          TOOLCHAIN_FILE="toolchain-${{ env.REPO_BRANCH }}-${{ matrix.TOOLCHAIN_TYPE }}.tar.gz"

          # æ£€æŸ¥å›ºå®šçš„toolchain releaseæ˜¯å¦å­˜åœ¨ï¼Œä»¥åŠæ˜¯å¦åŒ…å«å¯¹åº”çš„toolchainæ–‡ä»¶
          if gh release view "$RELEASE_TAG" >/dev/null 2>&1; then
            # æ£€æŸ¥å…·ä½“çš„toolchainæ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if gh release view "$RELEASE_TAG" --json assets | jq -e ".assets[] | select(.name == \"$TOOLCHAIN_FILE\")" >/dev/null 2>&1; then
              echo "exists=true" >> $GITHUB_OUTPUT
              echo "ğŸ” Toolchain file already exists: $TOOLCHAIN_FILE in release $RELEASE_TAG"
            else
              echo "exists=false" >> $GITHUB_OUTPUT
              echo "ğŸš€ Need to build toolchain: $TOOLCHAIN_FILE (release exists but file missing)"
            fi
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "ğŸš€ Need to create toolchain release and build: $TOOLCHAIN_FILE"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Space cleanup
        if: steps.check_toolchain.outputs.exists != 'true'
        uses: dd-ray/github-actions@free-disk
        with:
          build-mount-path: /openwrt

      - name: Build System Setup
        if: steps.check_toolchain.outputs.exists != 'true'
        uses: dd-ray/github-actions@openwrt-build-setup

      - name: Install LLVM
        if: steps.check_toolchain.outputs.exists != 'true'
        uses: dd-ray/github-actions@install-llvm

      - name: Clone OpenWrt
        if: steps.check_toolchain.outputs.exists != 'true'
        run: |
          ./script/tool.sh clone
          ln -sf ${{ env.SOURCE_PATH }} ${{ github.workspace }}/openwrt-source

      - name: Update feeds
        if: steps.check_toolchain.outputs.exists != 'true'
        run: ./script/tool.sh update_feeds

      - name: Generate configuration file
        if: steps.check_toolchain.outputs.exists != 'true'
        env:
          CONFIG_FILE: ${{ matrix.DEVICE }}.seed
        run: |
          ./script/tool.sh build_config
          echo "CONFIG_CCACHE=y" >> .config

      - name: Make defconfig
        if: steps.check_toolchain.outputs.exists != 'true'
        run: |
          cd "$SOURCE_PATH" || exit 1
          make defconfig

      - name: Download dependencies
        if: steps.check_toolchain.outputs.exists != 'true'
        run: |
          cd "$SOURCE_PATH" || exit 1
          echo "ğŸ“¥ Downloading source packages..."
          make download -j$(nproc) V=s

          # æ£€æŸ¥ä¸‹è½½çŠ¶æ€
          find dl -size 0 -exec rm -f {} \; 2>/dev/null || true

      - name: Build toolchain only
        if: steps.check_toolchain.outputs.exists != 'true'
        run: |
          cd "$SOURCE_PATH" || exit 1
          echo "ğŸ› ï¸ Building toolchain for ${{ matrix.TOOLCHAIN_TYPE }}..."

          # æ„å»º tools
          echo "ğŸ”¨ Building tools..."
          make tools/install -j$(nproc) V=s || make tools/install -j1 V=s

          # æ„å»º toolchain
          echo "ğŸ”§ Building toolchain..."
          make toolchain/install -j$(nproc) V=s || make toolchain/install -j1 V=s

          # æ£€æŸ¥æ„å»ºç»“æœ
          echo "ğŸ“‹ Toolchain build completed for ${{ matrix.TOOLCHAIN_TYPE }}"
          if [ -x "$(command -v ccache)" ] && [ "${{ env.USE_CCACHE }}" = "1" ]; then
            echo "ğŸ“Š CCache Statistics:"
            ccache -s
          fi
      - name: Clean Files
        id: clean
        run: |
          cd $SOURCE_PATH || exit 1
          make clean
          rm -rf tmp logs .config* dl
          ./scripts/feeds clean

      - name: Package toolchain
        if: steps.check_toolchain.outputs.exists != 'true'
        run: |
          cd "$SOURCE_PATH" || exit 1
          TOOLCHAIN_NAME="toolchain-${{ env.REPO_BRANCH }}-${{ matrix.TOOLCHAIN_TYPE }}"
          echo "ğŸ“¦ Packaging toolchain for ${{ matrix.TOOLCHAIN_TYPE }}"

          # æŸ¥æ‰¾å®é™…çš„toolchainç›®å½•
          TOOLCHAIN_DIRS=$(find staging_dir -name "toolchain-*" -type d 2>/dev/null || true)
          HOST_DIRS=$(find staging_dir -name "host*" -type d 2>/dev/null || true)
          BUILD_TOOLCHAIN_DIRS=$(find build_dir -name "toolchain-*" -type d 2>/dev/null || true)
          BUILD_HOST_DIRS=$(find build_dir -name "host" -type d 2>/dev/null || true)

          echo "ğŸ” Found directories to package:"
          echo "  Staging toolchain: $TOOLCHAIN_DIRS"
          echo "  Staging host: $HOST_DIRS"
          echo "  Build toolchain: $BUILD_TOOLCHAIN_DIRS"
          echo "  Build host: $BUILD_HOST_DIRS"

          if [ -z "$TOOLCHAIN_DIRS" ] && [ -z "$BUILD_TOOLCHAIN_DIRS" ]; then
            echo "âŒ No toolchain directories found"
            exit 1
          fi

          # åˆ›å»ºæ‰“åŒ…ç›®å½•åˆ—è¡¨
          PACK_DIRS=""
          [ -n "$TOOLCHAIN_DIRS" ] && PACK_DIRS="$PACK_DIRS staging_dir/toolchain-*"
          [ -n "$HOST_DIRS" ] && PACK_DIRS="$PACK_DIRS staging_dir/host*"
          [ -n "$BUILD_TOOLCHAIN_DIRS" ] && PACK_DIRS="$PACK_DIRS build_dir/toolchain-*"
          [ -n "$BUILD_HOST_DIRS" ] && PACK_DIRS="$PACK_DIRS build_dir/host"

          # æ‰“åŒ…å·¥å…·é“¾ï¼Œæ’é™¤ä¸å¿…è¦çš„æ–‡ä»¶
          tar -czf "${TOOLCHAIN_NAME}.tar.gz" \
            --exclude='*.o' \
            --exclude='*.lo' \
            --exclude='.libs' \
            --exclude='.git*' \
            --exclude='*.tmp' \
            --exclude='tmp.*' \
            $PACK_DIRS 2>/dev/null || {
              echo "âš ï¸ Some files failed to archive, continuing..."
            }

          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”ä¸ä¸ºç©º
          if [ -s "${TOOLCHAIN_NAME}.tar.gz" ]; then
            FILE_SIZE=$(du -h "${TOOLCHAIN_NAME}.tar.gz" | cut -f1)
            echo "âœ… Toolchain package created: $(ls -lh ${TOOLCHAIN_NAME}.tar.gz)"
            echo "ğŸ“¦ Package size: $FILE_SIZE"
            echo "TOOLCHAIN_FILE=${TOOLCHAIN_NAME}.tar.gz" >> $GITHUB_ENV
          else
            echo "âŒ Failed to create toolchain package"
            exit 1
          fi

      - name: Create toolchain release
        if: steps.check_toolchain.outputs.exists != 'true'
        uses: ncipollo/release-action@v1.14.0
        with:
          name: "OpenWrt Toolchains"
          allowUpdates: true
          tag: "toolchain"
          commit: main
          replacesArtifacts: false
          body: |
            ## ğŸ› ï¸ OpenWrt Toolchains å·¥å…·é“¾é›†åˆ

            è¿™ä¸ªreleaseåŒ…å«æ‰€æœ‰åˆ†æ”¯å’Œæ¶æ„çš„OpenWrt toolchainæ–‡ä»¶ï¼Œç»è¿‡ä¼˜åŒ–çš„æ„å»ºæµç¨‹ã€‚

            ### ğŸ“‹ å¯ç”¨çš„Toolchainæ–‡ä»¶

            #### Mainåˆ†æ”¯
            - `toolchain-main-aarch64_cortex-a53.tar.gz` - é€‚ç”¨äº nanopi-r5s ç­‰ Cortex-A53 è®¾å¤‡
            - `toolchain-main-aarch64_generic.tar.gz` - é€‚ç”¨äº cudy-tr3000 ç­‰é€šç”¨ aarch64 è®¾å¤‡  
            - `toolchain-main-x86_64.tar.gz` - é€‚ç”¨äº x86_64 è®¾å¤‡

            #### OpenWrt-24.10åˆ†æ”¯  
            - `toolchain-openwrt-24.10-aarch64_cortex-a53.tar.gz`
            - `toolchain-openwrt-24.10-aarch64_generic.tar.gz`
            - `toolchain-openwrt-24.10-x86_64.tar.gz`

            ### ğŸ”§ ä½¿ç”¨æ–¹æ³•
            ```bash
            # ä¸‹è½½å¯¹åº”çš„toolchainæ–‡ä»¶
            wget https://github.com/${{ github.repository }}/releases/download/toolchain/toolchain-{åˆ†æ”¯}-{ç±»å‹}.tar.gz

            # è§£å‹åˆ°OpenWrtæºç ç›®å½•
            tar -xzf toolchain-{åˆ†æ”¯}-{ç±»å‹}.tar.gz -C /path/to/openwrt/source/
            ```

            ### âœ¨ æ–°ç‰¹æ€§
            - ğŸš€ å¤šçº§ç¼“å­˜ç­–ç•¥ï¼ŒåŠ é€Ÿæ„å»º
            - ğŸ’¾ æ”¯æŒ ccache ç¼–è¯‘ç¼“å­˜
            - ğŸ”§ ä¼˜åŒ–çš„æ„å»ºé…ç½®
            - ğŸ“¦ æ›´å°çš„å·¥å…·é“¾åŒ…ä½“ç§¯

            ### ğŸ“ æœ€åæ›´æ–°
            - **æ—¶é—´**: ${{ github.run_id }}
            - **æ„å»ºé¡¹**: ${{ matrix.TOOLCHAIN_TYPE }} (${{ env.REPO_BRANCH }})
          artifacts: |
            ${{ env.SOURCE_PATH }}/${{ env.TOOLCHAIN_FILE }}
