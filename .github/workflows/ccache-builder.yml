name: CCache Builder

on:
  workflow_dispatch:
    inputs:
      REPO_URL:
        description: "OpenWrtä»“åº“"
        required: true
        default: "openwrt/openwrt"
        type: choice
        options:
          - "openwrt/openwrt"
      REPO_BRANCH:
        description: "OpenWrtåˆ†æ”¯"
        required: true
        default: "main"
        type: choice
        options:
          - "main"
          - "openwrt-24.10"
      TARGET_DEVICE:
        description: "ç›®æ ‡è®¾å¤‡"
        required: true
        default: "nanopi-r5s"
        type: choice
        options:
          - "nanopi-r5s"
          - "cudy-tr3000"
          - "x86_64"
      INCREMENTAL:
        description: "å¢é‡æ›´æ–°ccache"
        type: boolean
        default: true

env:
  REPO_URL: "https://github.com/${{ github.event.inputs.REPO_URL }}.git"
  REPO_BRANCH: ${{ github.event.inputs.REPO_BRANCH }}
  SOURCE_PATH: "/openwrt/openwrt-source"
  TZ: Asia/Shanghai
  BUILDER_PATH: ${{ github.workspace }}

jobs:
  build-ccache:
    runs-on: ubuntu-latest
    name: Build CCache ${{ github.event.inputs.TARGET_DEVICE }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set Environment Variables
        run: |
          # ä½¿ç”¨device-toolchain-mapping.shè„šæœ¬ç»Ÿä¸€ç®¡ç†æ˜ å°„å…³ç³»
          source script/device-toolchain-mapping.sh
          
          TOOLCHAIN_TYPE=$(get_toolchain_type "${{ github.event.inputs.TARGET_DEVICE }}")
          DEVICE_PLATFORM=$(get_device_platform "${{ github.event.inputs.TARGET_DEVICE }}")
          
          if [ "$TOOLCHAIN_TYPE" = "unknown" ] || [ "$DEVICE_PLATFORM" = "unknown" ]; then
            echo "âŒ Unsupported device: ${{ github.event.inputs.TARGET_DEVICE }}"
            ./script/device-toolchain-mapping.sh list-mappings
            exit 1
          fi
          
          echo "DEVICE_PLATFORM=${DEVICE_PLATFORM}" >> $GITHUB_ENV
          echo "TOOLCHAIN_TYPE=${TOOLCHAIN_TYPE}" >> $GITHUB_ENV
          echo "ğŸ“‹ Device: ${{ github.event.inputs.TARGET_DEVICE }} -> Platform: ${DEVICE_PLATFORM}, Toolchain: ${TOOLCHAIN_TYPE}"

      - name: Space cleanup
        uses: dd-ray/github-actions@free-disk
        with:
          build-mount-path: /openwrt

      - name: Build System Setup
        uses: dd-ray/github-actions@openwrt-build-setup

      - name: Install LLVM
        uses: dd-ray/github-actions@install-llvm

      - name: Clone OpenWrt
        run: |
          ./script/tool.sh clone
          ln -sf ${{ env.SOURCE_PATH }} ${{ github.workspace }}/openwrt-source

      - name: Download existing ccache
        if: ${{ github.event.inputs.INCREMENTAL == 'true' }}
        run: |
          CCACHE_RELEASE="ccache"
          CCACHE_FILE="ccache-${{ env.REPO_BRANCH }}-${{ env.DEVICE_PLATFORM }}.tar.gz"
          CCACHE_URL="https://github.com/${{ github.repository }}/releases/download/${CCACHE_RELEASE}/${CCACHE_FILE}"
          
          echo "ğŸ” Checking for existing ccache: $CCACHE_FILE"
          # å°è¯•ä¸‹è½½ç°æœ‰çš„ccache
          if wget --spider -q "$CCACHE_URL" 2>/dev/null; then
            echo "ğŸ“¦ Found existing ccache, downloading..."
            if wget -q "$CCACHE_URL"; then
              cd "$SOURCE_PATH" || exit 1
              if tar -xzf "../${CCACHE_FILE}"; then
                echo "âœ… CCache extracted successfully"
              else
                echo "âš ï¸ Failed to extract ccache, will start fresh"
              fi
              cd ..
              rm -f "${CCACHE_FILE}" || true
            else
              echo "âš ï¸ Failed to download ccache, will start fresh"
            fi
          else
            echo "ğŸ†• No existing ccache found, starting fresh"
          fi

      - name: Download toolchain
        run: |
          TOOLCHAIN_RELEASE="toolchain"
          TOOLCHAIN_FILE="toolchain-${{ env.REPO_BRANCH }}-${{ env.TOOLCHAIN_TYPE }}.tar.gz"
          TOOLCHAIN_URL="https://github.com/${{ github.repository }}/releases/download/${TOOLCHAIN_RELEASE}/${TOOLCHAIN_FILE}"
          
          echo "ğŸ” Downloading toolchain for ${{ env.TOOLCHAIN_TYPE }}"
          echo "ğŸ“ URL: ${TOOLCHAIN_URL}"
          
          # å…ˆæ£€æŸ¥toolchainæ˜¯å¦å­˜åœ¨
          if wget --spider -q "${TOOLCHAIN_URL}" 2>/dev/null; then
            echo "âœ… Toolchain found, downloading..."
            # é‡è¯•æœºåˆ¶ä¸‹è½½
            for attempt in 1 2 3; do
              if wget -q "${TOOLCHAIN_URL}"; then
                echo "ğŸ› ï¸ Toolchain downloaded successfully (attempt $attempt)"
                cd "$SOURCE_PATH" || exit 1
                if tar -xzf "../${TOOLCHAIN_FILE}"; then
                  echo "ğŸ“¦ Toolchain extracted successfully"
                  cd ..
                  rm -f "${TOOLCHAIN_FILE}"
                  break
                else
                  echo "âš ï¸ Failed to extract toolchain (attempt $attempt)"
                  cd ..
                  rm -f "${TOOLCHAIN_FILE}"
                  if [ $attempt -eq 3 ]; then
                    echo "âŒ Failed to extract toolchain after 3 attempts"
                    exit 1
                  fi
                fi
              else
                echo "âš ï¸ Failed to download toolchain (attempt $attempt)"
                if [ $attempt -eq 3 ]; then
                  echo "âŒ Failed to download toolchain after 3 attempts"
                  exit 1
                fi
                sleep 10
              fi
            done
          else
            echo "âŒ Toolchain not found: ${TOOLCHAIN_FILE}"
            echo "ğŸ’¡ è¯·å…ˆæ„å»ºå¯¹åº”çš„toolchain:"
            echo "gh workflow run 'toolchain-builder.yml' -f REPO_BRANCH='${{ env.REPO_BRANCH }}'"
            echo "ğŸ“‹ æˆ–æ£€æŸ¥å¯ç”¨çš„toolchainæ–‡ä»¶:"
            gh release view toolchain --json assets | jq -r '.assets[].name' | grep "toolchain-" || echo "No toolchain files found"
            exit 1
          fi

      - name: Update feeds
        run: ./script/tool.sh update_feeds

      - name: Generate configuration file
        env:
          CONFIG_FILE: ${{ github.event.inputs.TARGET_DEVICE }}.seed
        run: |
          ./script/tool.sh build_config
          echo "CONFIG_CCACHE=y" >> .config

      - name: Make download
        run: ./script/tool.sh make_download

      - name: Compile with ccache
        run: |
          cd "$SOURCE_PATH" || exit 1
          make -j$(nproc) || make -j1 V=s
          
          # æ£€æŸ¥ccacheä½¿ç”¨æƒ…å†µ
          if [ -x "$(command -v ccache)" ]; then
            echo "ğŸ“Š CCache Statistics:"
            ccache -s
          fi

      - name: Package ccache
        run: |
          cd "$SOURCE_PATH" || exit 1
          CCACHE_NAME="ccache-${{ env.REPO_BRANCH }}-${{ env.DEVICE_PLATFORM }}"
          
          # æ‰“åŒ…ccacheç›®å½•
          if [ -d ".ccache" ]; then
            tar -czf "${CCACHE_NAME}.tar.gz" .ccache/
            echo "âœ… CCache package created: $(ls -lh ${CCACHE_NAME}.tar.gz)"
            echo "CCACHE_FILE=${CCACHE_NAME}.tar.gz" >> $GITHUB_ENV
          else
            echo "âŒ No ccache directory found"
            exit 1
          fi

      - name: Create ccache release
        uses: ncipollo/release-action@v1.14.0
        with:
          name: "OpenWrt CCache"
          allowUpdates: true
          tag: "ccache"
          commit: main
          replacesArtifacts: false
          body: |
            ## ğŸš€ OpenWrt CCache ç¼–è¯‘ç¼“å­˜é›†åˆ
            
            è¿™ä¸ªreleaseåŒ…å«æ‰€æœ‰åˆ†æ”¯å’Œæ¶æ„çš„OpenWrt ccacheæ–‡ä»¶ã€‚
            
            ### ğŸ“‹ å¯ç”¨çš„CCacheæ–‡ä»¶
            
            #### Mainåˆ†æ”¯
            - `ccache-main-arm64.tar.gz` - é€‚ç”¨äº ARM64 è®¾å¤‡ (nanopi-r5s, cudy-tr3000)
            - `ccache-main-amd64.tar.gz` - é€‚ç”¨äº x86_64 è®¾å¤‡
            
            #### OpenWrt-24.10åˆ†æ”¯
            - `ccache-openwrt-24.10-arm64.tar.gz`
            - `ccache-openwrt-24.10-amd64.tar.gz`
            
            ### ğŸ”§ ä½¿ç”¨æ–¹æ³•
            ```bash
            # ä¸‹è½½å¯¹åº”æ¶æ„çš„ccacheæ–‡ä»¶
            wget https://github.com/${{ github.repository }}/releases/download/ccache/ccache-{åˆ†æ”¯}-{æ¶æ„}.tar.gz
            
            # è§£å‹åˆ°OpenWrtæºç ç›®å½•
            tar -xzf ccache-{åˆ†æ”¯}-{æ¶æ„}.tar.gz -C /path/to/openwrt/source/
            ```
            
            ### ğŸ“ æœ€åæ›´æ–°
            - **æ—¶é—´**: ${{ github.run_id }}
            - **æ„å»ºé¡¹**: ${{ env.DEVICE_PLATFORM }} (${{ env.REPO_BRANCH }})
            - **ç›®æ ‡è®¾å¤‡**: ${{ github.event.inputs.TARGET_DEVICE }}
            - **æ›´æ–°ç±»å‹**: ${{ github.event.inputs.INCREMENTAL == 'true' && 'å¢é‡æ›´æ–°' || 'å®Œæ•´é‡å»º' }}
          artifacts: |
            ${{ env.SOURCE_PATH }}/${{ env.CCACHE_FILE }} 