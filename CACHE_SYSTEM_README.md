# ğŸš€ OpenWrt Release-Based Cache System

è¿™æ˜¯ä¸€ä¸ªåŸºäºGitHub Releaseçš„OpenWrtæ„å»ºç¼“å­˜ç³»ç»Ÿï¼Œé€šè¿‡å°†toolchainå’Œccacheå‘å¸ƒåˆ°ç‹¬ç«‹çš„releaseæ¥å®ç°æŒä¹…åŒ–ç¼“å­˜ï¼Œçªç ´GitHub Actionsç¼“å­˜çš„é™åˆ¶ã€‚

## ğŸ“‹ ç³»ç»Ÿæ¦‚è§ˆ

### ğŸ”§ ç»„ä»¶æ„æˆ

1. **ä¸»æ„å»ºæµç¨‹** (`openwrt-ci.yml`) - ä¸»è¦çš„å›ºä»¶æ„å»ºå·¥ä½œæµ
2. **Toolchainæ„å»ºå™¨** (`toolchain-builder.yml`) - ç‹¬ç«‹æ„å»ºå’Œå‘å¸ƒtoolchain
3. **CCacheæ„å»ºå™¨** (`ccache-builder.yml`) - ç‹¬ç«‹æ„å»ºå’Œå‘å¸ƒccache
4. **ç¼“å­˜ç®¡ç†å™¨** (`script/cache-manager.sh`) - æ™ºèƒ½ç¼“å­˜ç®¡ç†è„šæœ¬

### ğŸ¯ ä¼˜åŠ¿ç‰¹ç‚¹

- âœ… **æŒä¹…å­˜å‚¨** - ä¸å—GitHub Actionsç¼“å­˜7å¤©é™åˆ¶
- âœ… **è·¨ä»“åº“å…±äº«** - å¯ä»¥åœ¨å¤šä¸ªé¡¹ç›®é—´å…±äº«ç¼“å­˜
- âœ… **æ™ºèƒ½æ£€æµ‹** - è‡ªåŠ¨æ£€æµ‹æ˜¯å¦éœ€è¦æ›´æ–°ç¼“å­˜
- âœ… **å¢é‡æ›´æ–°** - æ”¯æŒccacheå¢é‡æ›´æ–°
- âœ… **ç‰ˆæœ¬ç®¡ç†** - åŸºäºåˆ†æ”¯å’Œæ¶æ„çš„ç‰ˆæœ¬ç®¡ç†
- âœ… **è‡ªåŠ¨ç»´æŠ¤** - è‡ªåŠ¨ç»´æŠ¤è¿‡æœŸç¼“å­˜
- âœ… **æ— ç¼“å­˜å†²çª** - æ¸…æ™°çš„ç¼“å­˜èŒè´£åˆ†å·¥ï¼Œé¿å…ç‰ˆæœ¬æ··ä¹± â­ **æœ€æ–°ä¼˜åŒ–**

## ğŸ› ï¸ ä½¿ç”¨æŒ‡å—

### ğŸ—ï¸ åˆæ¬¡è®¾ç½®

1. **æ„å»ºToolchain**
   ```bash
   # æ‰‹åŠ¨è§¦å‘toolchainæ„å»º
   gh workflow run "toolchain-builder.yml" \
     -f REPO_BRANCH="main" \
     -f FORCE_REBUILD="false"
   ```

2. **æ„å»ºåˆå§‹CCache**
   ```bash
   # ä¸ºæ¯ä¸ªè®¾å¤‡æ„å»ºåˆå§‹ccache
   gh workflow run "ccache-builder.yml" \
     -f REPO_BRANCH="main" \
     -f TARGET_DEVICE="nanopi-r5s" \
     -f INCREMENTAL="false"
   ```

### ğŸš€ æ—¥å¸¸æ„å»º

è¿è¡Œä¸»æ„å»ºæµç¨‹æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ï¼š
1. æ£€æŸ¥å¹¶ä¸‹è½½å¯¹åº”çš„toolchain
2. æ£€æŸ¥å¹¶ä¸‹è½½å¯¹åº”çš„ccache
3. è¿›è¡Œå›ºä»¶æ„å»º
4. è‡ªåŠ¨æ›´æ–°ccacheåˆ°release

```bash
gh workflow run "openwrt-ci.yml" \
  -f REPO_BRANCH="main" \
  -f CCACHE="true"
```

### ğŸ”§ ç¼“å­˜ç®¡ç†

ä½¿ç”¨ç¼“å­˜ç®¡ç†è„šæœ¬è¿›è¡Œé«˜çº§ç®¡ç†ï¼š

```bash
# æ£€æŸ¥toolchainæ˜¯å¦éœ€è¦æ›´æ–°
./script/cache-manager.sh check-toolchain arm64 /path/to/source

# æ£€æŸ¥ccacheå¹´é¾„
./script/cache-manager.sh check-ccache-age arm64 7

# è‡ªåŠ¨ç»´æŠ¤æ¨¡å¼
./script/cache-manager.sh auto-maintain arm64 nanopi-r5s /path/to/source
```

## ğŸ“Š Releaseæ ‡ç­¾è§„èŒƒ

### Toolchain Release
- **æ ‡ç­¾æ ¼å¼**: `toolchain-{åˆ†æ”¯}-{toolchainç±»å‹}`
- **ç¤ºä¾‹**: 
  - `toolchain-main-aarch64_cortex-a53` (nanopi-r5s)
  - `toolchain-main-aarch64_generic` (cudy-tr3000)
  - `toolchain-main-x86_64` (x86_64)
- **åŒ…å«å†…å®¹**:
  - `build_dir/toolchain-*` - å·¥å…·é“¾æ„å»ºç›®å½•
  - `build_dir/host` - ä¸»æœºå·¥å…·ç›®å½•
  - `build_dir/target-*` - ç›®æ ‡æ¶æ„æ„å»ºç›®å½• â­ **æ–°å¢**
  - `staging_dir/toolchain-*` - å·¥å…·é“¾æš‚å­˜ç›®å½•
  - `staging_dir/host*` - ä¸»æœºæš‚å­˜ç›®å½•
  - `staging_dir/target-*` - ç›®æ ‡æ¶æ„æš‚å­˜ç›®å½• â­ **æ–°å¢**

### CCache Release
- **æ ‡ç­¾æ ¼å¼**: `ccache-{åˆ†æ”¯}-{æ¶æ„}`
- **ç¤ºä¾‹**: `ccache-main-arm64`, `ccache-openwrt-24.10-amd64`
- **åŒ…å«å†…å®¹**:
  - `.ccache/` ç›®å½•çš„å®Œæ•´å†…å®¹

### ğŸ¯ Toolchainç±»å‹æ˜ å°„

| è®¾å¤‡ | Toolchainç±»å‹ | æ¶æ„å¹³å° | è¯´æ˜ |
|------|---------------|----------|------|
| nanopi-r5s | `aarch64_cortex-a53` | arm64 | Cortex-A53ä¼˜åŒ– |
| cudy-tr3000 | `aarch64_generic` | arm64 | é€šç”¨aarch64 |
| x86_64 | `x86_64` | amd64 | x86_64æ¶æ„ |

## ğŸ® å·¥ä½œæµå‚æ•°

### Toolchain Builder å‚æ•°

| å‚æ•° | æè¿° | é»˜è®¤å€¼ | é€‰é¡¹ |
|------|------|--------|------|
| `REPO_URL` | OpenWrtä»“åº“ | `openwrt/openwrt` | - |
| `REPO_BRANCH` | OpenWrtåˆ†æ”¯ | `main` | `main`, `openwrt-24.10` |
| `FORCE_REBUILD` | å¼ºåˆ¶é‡å»º | `false` | `true`, `false` |

### CCache Builder å‚æ•°

| å‚æ•° | æè¿° | é»˜è®¤å€¼ | é€‰é¡¹ |
|------|------|--------|------|
| `REPO_URL` | OpenWrtä»“åº“ | `openwrt/openwrt` | - |
| `REPO_BRANCH` | OpenWrtåˆ†æ”¯ | `main` | `main`, `openwrt-24.10` |
| `TARGET_DEVICE` | ç›®æ ‡è®¾å¤‡ | `nanopi-r5s` | `nanopi-r5s`, `cudy-tr3000`, `x86_64` |
| `INCREMENTAL` | å¢é‡æ›´æ–° | `true` | `true`, `false` |

## ğŸ”„ ç¼“å­˜æ›´æ–°ç­–ç•¥

### è‡ªåŠ¨æ›´æ–°è§¦å‘æ¡ä»¶

**Toolchainæ›´æ–°**:
- OpenWrtæºç commitå‘ç”Ÿå˜åŒ–
- feedsé…ç½®æ–‡ä»¶å˜åŒ–
- æ‰‹åŠ¨å¼ºåˆ¶é‡å»º

**CCacheæ›´æ–°**:
- æ¯æ¬¡ä¸»æ„å»ºåè‡ªåŠ¨æ›´æ–°
- ccacheæ•°æ®å¤§å°è¶…è¿‡é˜ˆå€¼
- æ‰‹åŠ¨è§¦å‘å¢é‡/å®Œæ•´æ›´æ–°

### æ™ºèƒ½æ£€æµ‹æœºåˆ¶

ç³»ç»Ÿä¼šæ™ºèƒ½æ£€æµ‹ä»¥ä¸‹å˜åŒ–ï¼š
- ğŸ“ OpenWrtæºç ç‰ˆæœ¬å˜åŒ–
- ğŸ”§ æ„å»ºé…ç½®å˜åŒ–
- â° ç¼“å­˜å¹´é¾„è¶…é™
- ğŸ“Š ç¼“å­˜ä½¿ç”¨ç»Ÿè®¡

## ğŸ›¡ï¸ æœ€ä½³å®è·µ

### ğŸ¯ æ¨èç”¨æ³•

1. **é¦–æ¬¡ä½¿ç”¨**: å…ˆæ„å»ºtoolchainï¼Œå†æ„å»ºccacheï¼Œæœ€åè¿›è¡Œæ­£å¸¸æ„å»º
2. **å®šæœŸç»´æŠ¤**: ä½¿ç”¨auto-maintainæ¨¡å¼å®šæœŸæ£€æŸ¥å’Œæ›´æ–°ç¼“å­˜
3. **å¤šåˆ†æ”¯ç®¡ç†**: ä¸ºä¸åŒåˆ†æ”¯ç»´æŠ¤ç‹¬ç«‹çš„ç¼“å­˜
4. **å¢é‡æ›´æ–°**: ä¼˜å…ˆä½¿ç”¨å¢é‡æ›´æ–°æ¥èŠ‚çœæ—¶é—´å’Œèµ„æº

### âš ï¸ æ³¨æ„äº‹é¡¹

1. **å­˜å‚¨é™åˆ¶**: GitHub Releaseæœ‰å­˜å‚¨é™åˆ¶ï¼Œå¤§å‹ç¼“å­˜å¯èƒ½éœ€è¦æ¸…ç†
2. **ç½‘ç»œå¸¦å®½**: ä¸‹è½½å¤§å‹ç¼“å­˜æ–‡ä»¶éœ€è¦ç¨³å®šç½‘ç»œ
3. **Toolchainå…¼å®¹æ€§**: âš ï¸ **é‡è¦** - ä¸åŒè®¾å¤‡ä½¿ç”¨ä¸åŒçš„toolchainç±»å‹ï¼Œä¸å¯æ··ç”¨ï¼š
   - `nanopi-r5s` ä½¿ç”¨ `aarch64_cortex-a53`
   - `cudy-tr3000` ä½¿ç”¨ `aarch64_generic`
   - `x86_64` ä½¿ç”¨ `x86_64`
4. **æƒé™è¦æ±‚**: éœ€è¦æœ‰ä»“åº“çš„releaseå†™å…¥æƒé™
5. **é¦–æ¬¡æ„å»º**: ç¬¬ä¸€æ¬¡ä½¿ç”¨æ—¶éœ€è¦å…ˆæ„å»ºå¯¹åº”çš„toolchain release

## ğŸ”§ ç¼“å­˜ç³»ç»Ÿæ¶æ„æ”¹è¿›

### âœ¨ æœ€æ–°ä¼˜åŒ– (v2.0)

æˆ‘ä»¬å¯¹ç¼“å­˜ç³»ç»Ÿè¿›è¡Œäº†é‡å¤§æ”¹è¿›ï¼Œè§£å†³äº†ä¹‹å‰å­˜åœ¨çš„ç¼“å­˜å†²çªé—®é¢˜ï¼š

#### ğŸ”„ ç¼“å­˜èŒè´£é‡æ–°åˆ†å·¥

| ç¼“å­˜ç±»å‹ | è´Ÿè´£å†…å®¹ | æ›´æ–°ç­–ç•¥ | æŒä¹…æ€§ |
|----------|----------|----------|--------|
| **Toolchain Release** | å®Œæ•´æ„å»ºç¯å¢ƒ | æŒ‰éœ€æ„å»º | æ°¸ä¹… |
| **CCache Release** | ç¼–è¯‘ç»“æœç¼“å­˜ | æ¯æ¬¡æ„å»ºå | æ°¸ä¹… |
| **GitHub Actions Cache** | åŒ…æ„å»ºä¸´æ—¶æ–‡ä»¶ | æ¯æ¬¡æ„å»ºå | 7å¤© |

#### ğŸ“¦ Toolchain å®Œæ•´æ€§å¢å¼º

ä¿®å¤å‰çš„ toolchain åŒ…åªåŒ…å«åŸºç¡€å·¥å…·é“¾ï¼Œç°åœ¨åŒ…å«ï¼š
```
âœ… build_dir/toolchain-*    # å·¥å…·é“¾æ ¸å¿ƒ
âœ… build_dir/host           # ä¸»æœºå·¥å…· (å¦‚ e2fsprogs)
âœ… build_dir/target-*       # ç›®æ ‡æ„å»ºç¯å¢ƒ ğŸ†•
âœ… staging_dir/toolchain-*  # å·¥å…·é“¾æš‚å­˜
âœ… staging_dir/host*        # ä¸»æœºæš‚å­˜
âœ… staging_dir/target-*     # ç›®æ ‡æš‚å­˜ ğŸ†•
```

#### ğŸš« æ¶ˆé™¤ç¼“å­˜å†²çª

**é—®é¢˜**: ä¹‹å‰ GitHub Actions Cache å’Œ Toolchain Release éƒ½è¯•å›¾ç¼“å­˜ç›¸åŒçš„ç›®å½•ï¼Œå¯¼è‡´ç‰ˆæœ¬å†²çª

**è§£å†³**: 
- Toolchain Release è´Ÿè´£æä¾›å®Œæ•´æ„å»ºç¯å¢ƒ
- GitHub Actions Cache åªç¼“å­˜åŒ…æ„å»ºçš„ä¸´æ—¶æ–‡ä»¶ï¼š
  - `build_dir/target-*/linux-*/tmp` - åŒ…æ„å»ºä¸´æ—¶æ–‡ä»¶
  - `dl` - ä¸‹è½½çš„æºç åŒ…
  - `feeds` - feeds æºç 

#### ğŸ¯ ä¿®å¤æ•ˆæœ

- âœ… **è§£å†³ç¼–è¯‘é”™è¯¯**: å¦‚ `unknown type name 'blkid_probe'`
- âœ… **é¿å…ç‰ˆæœ¬æ··ä¹±**: æ¯ç§ç¼“å­˜æœ‰æ˜ç¡®çš„ç”¨é€”
- âœ… **æé«˜å¯é æ€§**: ä¸€è‡´çš„æ„å»ºç¯å¢ƒ
- âœ… **å‡å°‘å­˜å‚¨**: æ¶ˆé™¤é‡å¤ç¼“å­˜

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

**é—®é¢˜**: Toolchainä¸‹è½½å¤±è´¥
**è§£å†³**: æ£€æŸ¥releaseæ˜¯å¦å­˜åœ¨ï¼Œæˆ–æ‰‹åŠ¨è§¦å‘toolchainæ„å»º

**é—®é¢˜**: CCacheè§£å‹å¤±è´¥
**è§£å†³**: åˆ é™¤å¯¹åº”çš„ccache releaseï¼Œé‡æ–°æ„å»º

**é—®é¢˜**: æ„å»ºæ—¶é—´æ²¡æœ‰æ˜æ˜¾å‡å°‘
**è§£å†³**: æ£€æŸ¥ccacheå‘½ä¸­ç‡å’Œtoolchainæ˜¯å¦æ­£ç¡®åŠ è½½

### è°ƒè¯•å‘½ä»¤

```bash
# æ£€æŸ¥releaseçŠ¶æ€
gh release list --limit 20

# æŸ¥çœ‹å…·ä½“releaseä¿¡æ¯
gh release view toolchain-main-arm64

# æ‰‹åŠ¨ä¸‹è½½æµ‹è¯•
wget https://github.com/user/repo/releases/download/tag/file.tar.gz
```

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

| æ„å»ºé˜¶æ®µ | æ— ç¼“å­˜ | ä¼ ç»Ÿç¼“å­˜ | Releaseç¼“å­˜ |
|----------|--------|----------|-------------|
| Toolchainæ„å»º | 30-40åˆ†é’Ÿ | 5-10åˆ†é’Ÿ | 2-3åˆ†é’Ÿ |
| åŒ…ç¼–è¯‘ | 60-90åˆ†é’Ÿ | 20-30åˆ†é’Ÿ | 15-20åˆ†é’Ÿ |
| æ€»æ„å»ºæ—¶é—´ | 120-150åˆ†é’Ÿ | 40-60åˆ†é’Ÿ | 25-35åˆ†é’Ÿ |
| ç¼“å­˜æŒä¹…æ€§ | - | 7å¤© | æ°¸ä¹… |

---

ğŸ’¡ **æç¤º**: è¿™ä¸ªç¼“å­˜ç³»ç»Ÿç‰¹åˆ«é€‚åˆé¢‘ç¹æ„å»ºã€å¤šè®¾å¤‡æ”¯æŒçš„OpenWrté¡¹ç›®ï¼Œå¯ä»¥æ˜¾è‘—å‡å°‘æ„å»ºæ—¶é—´å’Œèµ„æºæ¶ˆè€—ã€‚ 